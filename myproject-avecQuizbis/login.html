<!DOCTYPE html>
<html lang="fr">
  <!-- Déclaration du type de document et définition de la langue principale en francais -->

<head>
  <meta charset="UTF-8">
  <!-- Définition de l'encodage des caractères en UTF-8 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- Compatibilité avec les anciennes versions d'Internet Explorer -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Paramètres pour une mise en page adaptée aux mobiles -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.0.4/js.cookie.min.js"></script>
  <!-- Inclusion de la bibliothèque js-cookie depuis un CDN -->
  <link rel="stylesheet" href="public/stylelogin.css?v=1.0">
  <!-- Lien vers le fichier CSS pour les styles de la page -->
  <title>Login</title>
  <!-- Titre de la page -->
</head>

<body>
  <div class="center">
    <!-- Conteneur central pour le formulaire de connexion -->
    <img src="public/CY-Tech_coul.png" alt="Logo">
    <!-- Logo de CYTech -->
    <form id="loginForm">
      <!-- Formulaire de connexion -->
      <h1> Bienvenue </h1>
      <div class="txt_field">
        <!-- Champ de texte pour le nom d'utilisateur -->
        <input type="text" id="username" required>
        <span> </span>
        <label>Identifiant </label>
      </div>
      <div class="txt_field">
        <!-- Champ de texte pour le mot de passe -->
        <input type="password" id="password" required>
        <span> </span>
        <label> Mot de passe </label>
      </div>
      <input type="submit" value="Se connecter">
      <!-- Bouton de soumission pour se connecter -->
      <div class="users_signup">
        <!-- Lien pour s'inscrire si l'utilisateur n'a pas de compte -->
        Vous n'avez pas de compte ? <a onclick="register()"  style="cursor: pointer;">S'inscrire</a>
      </div>
    </form>
    <form id="registerForm" style="display: none;">
      <!-- Formulaire d'inscription, caché par défaut -->
      <h1> Inscription </h1>
      <div class="txt_field">
        <!-- Champ de texte pour le nom d'utilisateur -->
        <input type="text" id="rUsername" required>
        <span> </span>
        <label>Identifiant </label>
      </div>
      <div class="txt_field">
        <!-- Champ de texte pour le mot de passe -->
        <input type="password" id="rPassword" required>
        <span> </span>
        <label> Mot de passe </label>
      </div>
      <div class="txt_field">
        <!-- Champ de texte pour confirmer le mot de passe -->
        <input type="password" id="confirmPassword" required>
        <span> </span>
        <label> Confirmer le mot de passe </label>
      </div>
      <input type="submit" value="S'inscrire" onclick="registerUser(event)">
      <!-- Bouton de soumission pour s'inscrire -->
      <div class="users_signup">
        <!-- Lien pour revenir au formulaire de connexion si l'utilisateur a déjà un compte -->
        Vous avez déjà un compte ? <a onclick="document.getElementById('registerForm').style.display = 'none';document.getElementById('loginForm').style.display = 'block';" style="cursor: pointer;">Se connecter</a>
      </div>
    </form>
  </div>

  <script>
    // Fonction pour gérer l'inscription de l'utilisateur
    function registerUser(e){
      e.preventDefault();
      const username = document.getElementById('rUsername').value;
      const password = document.getElementById('rPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      if(password !== confirmPassword){
        alert('Les mots de passe ne correspondent pas');
        return;
      }
      if(username === '' || password === ''){
        alert('Veuillez remplir tous les champs');
        return;
      }
      fetch("/scripts/register.php", {
        method: "POST",
        body: JSON.stringify({
          username: username,
          password: password
        }),
        headers: {
          "Content-type": "application/json; charset=UTF-8"
        }
      }).then(response => response.json())
      .then(response => {
        if(response.error){
          alert(response.error);
        } else {
          alert('Inscription réussie');
          document.getElementById('registerForm').style.display = 'none';
          document.getElementById('loginForm').style.display = 'block';
        }
      });
    }
    // Fonction pour afficher le formulaire d'inscription
    function register() {
      //on cache le formulaire de login
      document.getElementById('loginForm').style.display = 'none';
      //on affiche le formulaire d'inscription
      document.getElementById('registerForm').style.display = 'block';
    }
    // Écouteur d'événement pour gérer la soumission du formulaire de connexion
    document.getElementById('loginForm').addEventListener('submit', async function (event) {
      event.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      let response = await fetch("/scripts/login.php", {
        method: "POST",
        body: JSON.stringify({
          username: username,
          password: password
        }),
        headers: {
          "Content-type": "application/json; charset=UTF-8"
        }
      });
      response = await response.json();
      if (response.error) {
        alert(response.error);
      } else {
        Cookies.set("user", JSON.stringify({
          role: response.role,
          username: username
        }), {
          path: "/",
          expires: new Date(new Date().getTime() + (60 * 360 * 1000))
        });
        // Récupère l'URL de retour
        const urlParams = new URLSearchParams(window.location.search);
        const returnUrl = urlParams.get('returnUrl');
        if (returnUrl) {
          window.location.href = returnUrl;
        }
        else {
          window.location.href = 'index.html';
        }
      }
    });
  </script>
</body>

</html>